# msa-capstone-project
<img src= "https://t1.daumcdn.net/cfile/tistory/997A00365C79475E04?download">


  
## ğŸ‘« Team

   |íŒ€|ì„±ëª…|ì§ê¸‰|ì‚¬ë²ˆ|ì†Œì†||
   |:----:|:------:|:------:|:------|:------|------|
   |2|ğŸ–ì„œì •í›ˆ|ê³¼ì¥|201600017|ì„œë¹„ìŠ¤í˜ì‹ ì„¼í„°|ì œì¡°ë°©ì‚°ë‹´ë‹¹/ë°©ì‚°ìš´ì˜2íŒ€|
   ||  ì‹ ì„¸í˜¸|ëŒ€ë¦¬|202100009|ì„œë¹„ìŠ¤í˜ì‹ ì„¼í„°|ì œì¡°ë°©ì‚°ë‹´ë‹¹/ì œì¡°ìš´ì˜íŒ€|
   ||   ì •í˜¸í˜„|ì‚¬ì›|201903684|ë°ì´í„°ì„¼í„°|ê¸ˆìœµìš´ì˜íŒ€|

# ì„œë¹„ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤

ê¸°ëŠ¥ì  ìš”êµ¬ì‚¬í•­
1. ì‚¬ìš©ìê°€ ì£¼ë¬¸ì„ í•œë‹¤
2. ì£¼ë¬¸ì´ ì‹œì‘ë˜ë©´ ë°°ì†¡ì´ ì‹œì‘ëœë‹¤
3. ì£¼ë¬¸ì´ ì‹œì‘ë˜ë©´ ì¬ê³ ê°€ ê°ì†Œí•œë‹¤
4. ì£¼ë¬¸ì´ ì·¨ì†Œë˜ë©´ ë°°ì†¡ì´ ì·¨ì†Œëœë‹¤
5. ì£¼ë¬¸ì´ ì·¨ì†Œë˜ë©´ ì¬ê³ ê°€ ì¦ê°€í•œë‹¤


ë¹„ê¸°ëŠ¥ì  ìš”êµ¬ì‚¬í•­
1. ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ë¥¼ ë„˜ë‚˜ë“œëŠ” ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬
2. ì£¼ë¬¸ì‹œ ì¬ê³ ê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤
3. ê³ ê°ì´ ì£¼ë¬¸ìƒíƒœë¥¼ ì£¼ë¬¸ì‹œìŠ¤í…œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤ (CQRS)


# SAGA
## - êµ¬í˜„
> ì„œë¹„ìŠ¤ë¥¼ ì•„ë˜ì™€ ê°™ì€ ë°©ë²•ìœ¼ë¡œ ê°œë³„ì ìœ¼ë¡œ ì‹¤í–‰í•œë‹¤. 

```
cd order
mvn spring-boot:run
```

```
cd orderView
mvn spring-boot:run
```

```
cd delivery
mvn spring-boot:run
```

```
cd inventory
mvn spring-boot:run
```

* DDDì ìš©
> 4ê°œì˜ ë„ë©”ì¸ìœ¼ë¡œ ê´€ë¦¬ë˜ê³  ìˆìœ¼ë©° ì£¼ë¬¸(Order), ë°°ì†¡(Delivery), ì¬ê³ (Inventory), ì£¼ë¬¸ì¡°íšŒ(OrderView)ìœ¼ë¡œ êµ¬ì„±ëœë‹¤.

```
@Entity
@Table(name="Order_table")
public class Order  {

    @Id
    @GeneratedValue(strategy=GenerationType.AUTO)
    private Long id;
    private Long deliveryId;
    private String productName;
    private String productId;
    private Integer qty;
    private String address;
    private String orderStatus;

    @PostPersist
    public void onPostPersist(){
        Ordered ordered = new Ordered();
        BeanUtils.copyProperties(this, ordered);

        onlineshop.external.Inventory inventory = new onlineshop.external.Inventory();
        OrderApplication.applicationContext.getBean(onlineshop.external.InventoryService.class).deductStock(inventory);

        ordered.publishAfterCommit();
    }
    
```

* ì„œë¹„ìŠ¤ í˜¸ì¶œíë¦„(Sync)
> ì£¼ë¬¸(Order) -> ì¬ê³ ì¡°íšŒ(Inventory)ê°„ í˜¸ì¶œì€ ë™ê¸°ì‹ìœ¼ë¡œ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ëŠ” íŠ¸ëœì ì…˜ìœ¼ë¡œ ì²˜ë¦¬

* ê³ ê°ì´ ìƒí’ˆ,ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ê³  ì£¼ë¬¸ í•œë‹¤.
* ì¬ê³ ì°¨ê°ì„ í•˜ê¸°ìœ„í•´ FeinClientë¥¼ ì´ìš©í•˜ì—¬ ì¸í„°í˜ì´ìŠ¤(Proxy)ë¥¼ êµ¬í˜„í•œë‹¤.
* ì¬ê³ ìˆ˜ëŸ‰ì„ í™•ì¸í•˜ì—¬ ìˆ˜ë¬¸ìˆ˜ëŸ‰ ë§Œí¼ ì¬ê³ ì°¨ê°ì´ ëœ ì´í›„ (@PostPersist) ì£¼ë¬¸ì´ ë˜ë„ë¡ ì²˜ë¦¬í•œë‹¤.

```
// InventoryService.java
package onlineshop.external;

import ...

@FeignClient(name="inventory", url="http://inventory:8083")
public interface InventoryService {
    @RequestMapping(method= RequestMethod.GET, path="/inventories")
    public void deductStock(@RequestBody Inventory inventory);

}
```
* ì‹¤ì‹œê°„ ì¬ê³  ì°¨ê°ì„ ìœ„í•´ ìƒí’ˆid ì™€ ì£¼ë¬¸ìˆ˜ëŸ‰ì„ ì…ë ¥ ë°›ì•„ ì¬ê³  ì°¨ê° ìˆ˜í–‰
* ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•˜ë©´ 'ì¬ê³  ë¶€ì¡±' ì˜ˆì™¸ì²˜ë¦¬
* ìˆ˜ëŸ‰ì´ ì¶©ë¶„í•˜ë©´ db ìˆ˜ëŸ‰ ì°¨ê° í›„ ê²°ê³¼ ë¦¬í„´
```
@RestController
public class InventoryController {

    @Autowired
    InventoryService inventoryService;

    @PostMapping("/deduct")
    Inventory deduckQty(@RequestBody String data) throws Exception {
        System.out.println(data);

        ObjectMapper mapper = new ObjectMapper();
        Inventory product = null;
        try {
            product = mapper.readValue(data, Inventory.class);
        } catch (IOException e) {
            e.printStackTrace();
        }

        Inventory inventory = inventoryService.getProductByProductId(product.getProductId());

        if(inventory.getQty() < product.getQty()){
            throw new Exception("ì¬ê³  ë¶€ì¡±");
        }else{
            inventoryService.decreaseStock(product.getProductId(),product.getQty());
        }

        return inventory;
    }
}
```
* ì„œë¹„ìŠ¤ í˜¸ì¶œíë¦„(Async)
> ì£¼ë¬¸(Order) -> ë°°ì†¡(delivery)ê°„ ì²˜ë¦¬ëŠ” ë¹„ë™ê¸°ì‹ìœ¼ë¡œ ì²˜ë¦¬í•¨

* ë°°ì†¡ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸ í•˜ê³  ê·¸ ë‚´ì—­ì„ Kafkaë¡œ ì „ë‹¬

```
package onlineshop.domain;

import ..

@Entity
@Table(name="Delivery_table")
public class Delivery  {

    @Id
    @GeneratedValue(strategy=GenerationType.AUTO)
    private Long id;
    private Long orderId;
..

    @PostPersist
    public void onPostPersist(){
        DeliveryStarted deliveryStarted = new DeliveryStarted();
        BeanUtils.copyProperties(this, deliveryStarted);
        deliveryStarted.publishAfterCommit();
    }
```


# CQRS
* ì£¼ë¬¸ ì„œë¹„ìŠ¤(8081)ì™€ ë°°ì†¡ ì„œë¹„ìŠ¤(8082), ì¬ê³  ì„œë¹„ìŠ¤(8083)ì„ ê°ê° ì‹¤í–‰
```
cd order
mvn spring-boot:run
```

```
cd delivery
mvn spring-boot:run
```

```
cd inventory
mvn spring-boot:run
```

* ìƒí’ˆ ì£¼ë¬¸ 
```
http POST localhost:8081/orders productId=1 qty=1
```

``` 
gitpod /workspace/msa-capstone-project (main) $ http POST :8081/orders id=1 qty=1

HTTP/1.1 201 
Content-Type: application/json;charset=UTF-8
Date: Tue, 17 May 2022 05:12:48 GMT
Location: http://localhost:8081/orders/1
Transfer-Encoding: chunked

{
    "_links": {
        "order": {
            "href": "http://localhost:8081/orders/1"
        },
        "self": {
            "href": "http://localhost:8081/orders/1"
        }
    },
    "address": null,
    "deliveryId": null,
    "orderStatus": null,
    "productId": null,
    "productName": null,
    "qty": 1
}

```

